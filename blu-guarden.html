<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BLU å°èŠ±åœ’ v5.5 ï½œ æº«æŸ”è¦ºé†’ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #faf8ff;
      --card: #ffffffee;
      --accent: #c9a7ff;
      --glow: #e0c8ff88;
      --text: #333;
      --soft: #777;
    }
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
      background: linear-gradient(135deg, #fdf2ff, #f0e8ff);
      color: var(--text);
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 20px 16px;
    }
    .container { max-width: 460px; width: 100%; }
    .card {
      background: var(--card);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 12px 32px #0000000a;
      margin-bottom: 20px;
      border: 1px solid #f0e8ff;
    }
    h1 { font-size: 1.7rem; text-align: center; margin: 0 0 8px; background: linear-gradient(90deg, #b388ff, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    h2 { font-size: 1.25rem; margin: 24px 0 12px; color: #6b46c1; }
    input, button {
      width: 100%; padding: 12px 16px; margin: 8px 0;
      border-radius: 16px; border: 1.5px solid #e2d9ff;
      font-size: 1rem;
    }
    input { background: white; }
    button {
      background: linear-gradient(135deg, #d8b4ff, #9f7aea);
      color: white; font-weight: 600; cursor: pointer;
      border: none; box-shadow: 0 4px 12px var(--glow);
      transition: all 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px var(--glow); }
    .mood-buttons {
      display: flex; gap: 12px; margin: 16px 0; justify-content: center;
    }
    .mood-btn {
      font-size: 2.8rem; padding: 12px; width: 72px; height: 72px;
      border-radius: 50%; background: white; border: 2px solid #e2d9ff;
      cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px #00000008;
    }
    .mood-btn:hover { transform: scale(1.1); }
    .mood-btn.selected { border-color: #9f7aea; background: #f0e8ff; box-shadow: 0 0 20px var(--glow); }
    .streak {
      display: inline-block; padding: 6px 14px; background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
      border-radius: 20px; font-weight: 700; color: #6b4700; font-size: 0.9rem;
    }
    .status { text-align: center; margin: 12px 0; font-size: 0.95rem; min-height: 24px; }
    .welcome { text-align: center; font-size: 1.1rem; line-height: 1.6; color: #5b46a1; }
    .blu { font-size: 1.4rem; font-weight: 700; color: #7c3aed; }
    .history { font-size: 0.9rem; max-height: 200px; overflow-y: auto; }
    .mood-item { padding: 6px 0; border-bottom: 1px solid #f0e8ff; display: flex; justify-content: space-between; }
    .back-link { text-align: center; margin-top: 10px; }
    .back-link a { color: #9f7aea; text-decoration: none; font-size: 0.9rem; }
    .back-link a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">

    <div class="card">
      <h1>ğŸŒ¸ BLU å°èŠ±åœ’</h1>
      <p style="text-align:center;color:#777;margin:0;">æ„›çš„é‡é‡ï¼Œå¾é€™è£¡é–‹å§‹è¢«çœ‹è¦‹</p>
    </div>

    <!-- ç™»å…¥å€ -->
    <div id="authCard" class="card">
      <h2>ğŸŒ¿ å›åˆ°ä½ çš„èŠ±åœ’</h2>
      <input id="email" type="email" placeholder="email" />
      <input id="password" type="password" placeholder="å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½ï¼‰" />
      <button id="signupBtn">ğŸŒ± ç¬¬ä¸€æ¬¡ä¾† ï½œ ç¨®ä¸‹ä¸€é¡†ç¨®å­</button>
      <button id="loginBtn">ğŸŒ¸ å·²ç¶“æœ‰èŠ±åœ’ ï½œ å›å®¶</button>
      <p class="status" id="authStatus"></p>
      <div class="back-link">
        <a href="index.html">â† å›åˆ°é¡å­åº­é™¢</a>
      </div>
    </div>

    <!-- ä¸»ç•«é¢ -->
    <div id="appArea" style="display:none">
      <div class="card">
        <div class="welcome" id="welcomeMsg">è¼‰å…¥ä¸­â€¦</div>
        <p style="text-align:center;margin:8px 0;">
          ç¸½ç´¯ç© BLU åšåº¦ï¼š<span class="blu" id="totalBlu">0</span> <br>
          <span style="color:#777;">ï¼ˆæ¯ä¸€æ¬¡è¦ºå¯Ÿï¼Œéƒ½æœƒè®“æ„›æ›´åšå¯¦ä¸€é»ï¼‰</span>
        </p>
        <p style="text-align:center;">
          éˆé­‚å…¥å£æ¨™ç±¤ï¼š<span id="entryLabel">è¼‰å…¥ä¸­â€¦</span>
        </p>
        <div style="text-align:center;margin:16px 0;">
          <span class="streak" id="streakBadge">ğŸ”¥ é€£çºŒ 0 å¤©</span>
        </div>
      </div>

      <div class="card">
        <h2>ğŸŒ™ ä»Šå¤©ä½ æ„Ÿè¦ºå¦‚ä½•ï¼Ÿ</h2>
        <div class="mood-buttons">
          <button class="mood-btn" data-mood="good">ğŸ¥°</button>
          <button class="mood-btn" data-mood="neutral">ğŸ™‚</button>
          <button class="mood-btn" data-mood="bad">ğŸ¥º</button>
        </div>
        <p class="status" id="moodStatus">ï¼ˆè¼•è¼•é»ä¸€å€‹ï¼Œè¨˜éŒ„ä»Šå¤©çš„ä½ ï¼‰</p>
      </div>

      <div class="card">
        <h2>ğŸ“œ æœ€è¿‘çš„å¿ƒæƒ…è¶³è·¡</h2>
        <div class="history" id="moodHistory">è¼‰å…¥ä¸­â€¦</div>
      </div>

      <div class="card" style="text-align:center;">
        <button id="logoutBtn">ğŸŒ¿ å®‰éœé›¢é–‹èŠ±åœ’</button>
      </div>
    </div>
  </div>

<script>
  // âš ï¸ é‡è¦ï¼šè«‹åœ¨ä¸‹é¢å…©è¡Œå¡«å…¥ä½ çš„ Supabase å°ˆæ¡ˆè³‡è¨Š
  // å¯ä»¥åœ¨ Supabase Dashboard > Settings > API æ‰¾åˆ°
  const supabaseUrl = 'https://amqgpwrhxzrhvaknsasl.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcWdwd3JoeHpyaHZha25zYXNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NzExMDYsImV4cCI6MjA4MDM0NzEwNn0.cOVpCvBS42_GIBR2zA4J0TqatYMZgeQ-mwLwYjmPTKU';

  const client = supabase.createClient(supabaseUrl, supabaseKey);

  const moodButtons = document.querySelectorAll('.mood-btn');
  const authStatus = document.getElementById('authStatus');
  const moodStatus = document.getElementById('moodStatus');
  const totalBluEl = document.getElementById('totalBlu');
  const entryLabelEl = document.getElementById('entryLabel');
  const welcomeMsg = document.getElementById('welcomeMsg');
  const streakBadge = document.getElementById('streakBadge');
  const moodHistory = document.getElementById('moodHistory');

  // ====== å·¥å…·å‡½æ•¸ ======
  function calculateLifeNumber(birthDate) {
    const digits = birthDate.replace(/-/g, '');
    let sum = digits.split('').reduce((a, b) => a + +b, 0);
    while (sum > 9) sum = String(sum).split('').reduce((a, b) => a + +b, 0);
    return sum;
  }

  function generateEntryLabel(lifeNumber, totalBlu) {
    const labels = [
      "å‰›ç™¼èŠ½çš„å°ç¨®å­", "æ‚„æ‚„ç¶»æ”¾çš„èŠ±è‹", "åœ¨é¢¨ä¸­æ–æ›³çš„å°è‰", "é–‹å§‹çµæœçš„å°æ¨¹",
      "æ²æµ´é™½å…‰çš„å‘æ—¥è‘µ", "éœéœå®ˆè­·çš„å¤œä¾†é¦™", "è‡ªç”±é£›ç¿”çš„è’²å…¬è‹±", "æ²‰éœæ·±æ ¹çš„è€æ¨¹",
      "èˆ‡æœˆå…‰å…±èˆçš„ç²¾éˆ", "æ°¸æ†å‘¼å¸çš„æ£®æ—"
    ];
    const index = Math.min(Math.floor(totalBlu / 2), labels.length - 1);
    return `${lifeNumber}è™Ÿéˆé­‚ï½œ${labels[index]}`;
  }

  // ====== ç™»å…¥ç›¸é—œ ======
  document.getElementById('signupBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password || password.length < 6) {
      authStatus.textContent = "è«‹å¡«å®Œæ•´å–”ï¼ˆå¯†ç¢¼è‡³å°‘ 6 ä½ï¼‰ğŸŒ±";
      return;
    }
    authStatus.textContent = "è¨»å†Šä¸­...";
    const { error } = await client.auth.signUp({ email, password });
    if (error) {
      authStatus.textContent = "âŒ " + error.message;
    } else {
      authStatus.textContent = "ğŸŒ¸ è¨»å†ŠæˆåŠŸï¼è«‹ç›´æ¥æŒ‰ã€Œç™»å…¥ã€æŒ‰éˆ•é€²å…¥èŠ±åœ’";
      // è¨»ï¼šå¦‚æœä½ çš„ Supabase å•Ÿç”¨äº† Email ç¢ºèªï¼Œä½¿ç”¨è€…éœ€è¦å…ˆæ”¶ä¿¡ç¢ºèª
      // å¯ä»¥åœ¨ Supabase Dashboard > Authentication > Settings > Email Auth èª¿æ•´
    }
  });

  document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    authStatus.textContent = "ç™»å…¥ä¸­...";
    const { data, error } = await client.auth.signInWithPassword({ email, password });
    if (error) {
      authStatus.textContent = "âŒ " + error.message;
    } else {
      authStatus.textContent = "ğŸŒ¸ ç™»å…¥æˆåŠŸï¼";
      refreshUser(data.user);
    }
  });

  document.getElementById('logoutBtn')?.addEventListener('click', async () => {
    await client.auth.signOut();
    location.reload();
  });

  // ====== ä¸»è¦æ¸²æŸ“ ======
  async function refreshUser(user) {
    if (!user) {
      document.getElementById('appArea').style.display = 'none';
      document.getElementById('authCard').style.display = 'block';
      return;
    }
    document.getElementById('authCard').style.display = 'none';
    document.getElementById('appArea').style.display = 'block';

    // æª¢æŸ¥ profile
    let { data: profile } = await client.from('profiles').select('*').eq('id', user.id).single();
    if (!profile || !profile.birth_date) {
      // âœ… åŠ å…¥æ ¼å¼é©—è­‰
      let birth = prompt("ğŸŒ± ç¬¬ä¸€æ¬¡ä¾†ï¼Œè«‹å‘Šè¨´æˆ‘ä½ çš„ç”Ÿæ—¥ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼Œä¾‹å¦‚ 1990-07-15ï¼‰");
      if (!birth) {
        alert("æ²’é—œä¿‚ï¼Œæ”¹å¤©å†å‘Šè¨´æˆ‘ä¹Ÿå¯ä»¥å–”");
        await client.auth.signOut();
        location.reload();
        return;
      }
      // é©—è­‰æ ¼å¼
      if (!/^\d{4}-\d{2}-\d{2}$/.test(birth)) {
        alert("æ ¼å¼å°æç¤ºï¼šè¦åƒ 1990-07-15 é€™æ¨£å–”ï½è«‹é‡æ–°ç™»å…¥å¾Œå†è©¦");
        await client.auth.signOut();
        location.reload();
        return;
      }
      const lifeNumber = calculateLifeNumber(birth);
      await client.from('profiles').upsert({ id: user.id, birth_date: birth, life_number: lifeNumber });
      profile = { birth_date: birth, life_number: lifeNumber, entry_label: generateEntryLabel(lifeNumber, 0) };
    }

    welcomeMsg.textContent = `æ­¡è¿å›å®¶ï¼Œ${profile.life_number}è™Ÿéˆé­‚ ğŸŒ¸`;
    await renderAll(user.id, profile);
  }

  async function renderAll(userId, profile) {
    const { data: bluData } = await client.from('blu_logs').select('blu_value').eq('user_id', userId);
    const totalBlu = bluData?.reduce((sum, l) => sum + (parseFloat(l.blu_value) || 0), 0) || 0;
    totalBluEl.textContent = totalBlu.toFixed(1);

    const newLabel = generateEntryLabel(profile.life_number, totalBlu);
    if (newLabel !== profile.entry_label) {
      await client.from('profiles').update({ entry_label: newLabel }).eq('id', userId);
    }
    entryLabelEl.textContent = newLabel;

    // å¿ƒæƒ…æ­·å² + streak
    const { data: logs } = await client.from('mood_logs').select('date,mood').eq('user_id', userId).order('date', { ascending: false });
    renderMoodHistory(logs || []);

    // ä»Šå¤©æ˜¯å¦å·²è¨˜éŒ„
    const today = new Date().toISOString().split('T')[0];
    const todayLog = logs?.find(l => l.date === today);
    moodButtons.forEach(b => b.classList.toggle('selected', b.dataset.mood === todayLog?.mood));
    moodStatus.textContent = todayLog ? "ğŸŒ¿ ä»Šå¤©å·²ç¶“è¢«æº«æŸ”è¨˜éŒ„ï¼Œå¯ä»¥éš¨æ™‚æ›´æ–°å–”" : "ï¼ˆè¼•è¼•é»ä¸€å€‹ï¼Œè¨˜éŒ„ä»Šå¤©çš„ä½ ï¼‰";
  }

  function renderMoodHistory(logs) {
    if (!logs.length) {
      moodHistory.innerHTML = "<p style='color:#999;text-align:center;'>é‚„æ²’æœ‰è¶³è·¡å–”ï½</p>";
      streakBadge.textContent = "ğŸŒ± é–‹å§‹è¨˜éŒ„å§";
      return;
    }

    let streak = 0;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let cur = new Date(today);

    while (true) {
      const d = cur.toISOString().split('T')[0];
      if (logs.some(l => l.date === d)) {
        streak++;
        cur.setDate(cur.getDate() - 1);
      } else {
        break;
      }
    }
    streakBadge.textContent = streak ? `ğŸ”¥ é€£çºŒ ${streak} å¤©` : "ğŸŒ± é–‹å§‹è¨˜éŒ„å§";

    const html = logs.slice(0, 30).map(l => {
      const emo = { good: "ğŸ¥°", neutral: "ğŸ™‚", bad: "ğŸ¥º" }[l.mood];
      const date = new Date(l.date);
      const isToday = l.date === new Date().toISOString().split('T')[0];
      const dateStr = isToday ? "ä»Šå¤©" : `${date.getMonth() + 1}/${date.getDate()}`;
      return `<div class="mood-item"><span>${dateStr}</span><span>${emo}</span></div>`;
    }).join('');
    moodHistory.innerHTML = html || "é‚„æ²’æœ‰è¶³è·¡";
  }

  // ====== å¿ƒæƒ…è¨˜éŒ„ ======
  moodButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const { data: { user } } = await client.auth.getUser();
      if (!user) {
        moodStatus.textContent = "è«‹å…ˆç™»å…¥å–” ğŸŒ±";
        return;
      }

      const mood = btn.dataset.mood;
      const today = new Date().toISOString().split('T')[0];
      moodStatus.textContent = "æ­£åœ¨ç¨®ä¸‹ä¸€æœµå°èŠ±â€¦";

      const { error } = await client.from('mood_logs').upsert({
        user_id: user.id, date: today, mood
      }, { onConflict: 'user_id,date' });

      if (error) {
        moodStatus.textContent = "âŒ å‡ºéŒ¯äº†ï¼š" + error.message;
        console.error("Mood Log Error:", error);
        return;
      }

      moodButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');

      // âœ… ä¿®å¾©ï¼šæ”¹ç”¨ description è€Œé note
      const insertResult = await client.from('blu_logs').insert({
        user_id: user.id,
        blu_value: 0.5,
        description: `å¿ƒæƒ…è¨˜éŒ„ ${mood}`
      });

      if (insertResult.error) {
        console.error("BLU Log Error:", insertResult.error);
      }

      const texts = {
        good: "ä»Šå¤©åƒè¢«é™½å…‰è¦ªå»",
        neutral: "ä»Šå¤©åƒé›²æœµä¸€æ¨£å¹³éœ",
        bad: "ä»Šå¤©æœ‰é»å¡ï¼Œæ²’é—œä¿‚ï¼Œæ˜å¤©æœƒæ›´å¥½"
      };
      moodStatus.textContent = `ğŸŒ¸ ${texts[mood]} ï½œ +0.5 BLU å·²ç¨®ä¸‹`;

      const { data: profile } = await client.from('profiles').select('*').eq('id', user.id).single();
      await renderAll(user.id, profile);
    });
  });

  // å•Ÿå‹•
  (async () => {
    const { data: { user } } = await client.auth.getUser();
    refreshUser(user);
  })();
</script>

<!--
âš ï¸ é‡è¦æé†’ï¼š
1. è«‹ç¢ºèª Supabase ä¸­ mood_logs è¡¨æœ‰è¨­å®š RLS (Row Level Security)
   - Policy: using (auth.uid() = user_id) with check (auth.uid() = user_id)

2. è«‹ç¢ºèª Supabase ä¸­ blu_logs è¡¨çš„æ¬„ä½åç¨±æ˜¯ 'description' è€Œé 'note'

3. å¦‚æœè¦å•Ÿç”¨ Email ç¢ºèªåŠŸèƒ½ï¼š
   - å‰å¾€ Supabase Dashboard > Authentication > Settings
   - è¨­å®š SMTP æˆ–ä½¿ç”¨ Supabase å…§å»ºçš„éƒµä»¶æœå‹™
-->
</body>
</html>
