<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>BLU å°å¯¦é©—å®¤ v4.0 - éˆé­‚è¦ºé†’ç‰ˆ</title>
  </head>
  <body>
    <h1>BLU å°å¯¦é©—å®¤ v4.0 - éˆé­‚è¦ºé†’ç‰ˆ</h1>

    <h2>1. ç™»å…¥ / è¨»å†Š</h2>
    <p>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
    </p>
    <p>
      <button id="signupBtn">è¨»å†Šï¼ˆç¬¬ä¸€æ¬¡ç”¨ï¼‰</button>
      <button id="loginBtn">ç™»å…¥</button>
    </p>
    <p id="authStatus"></p>

    <hr />

    <div id="appArea" style="display: none">
      <h2>2. éˆé­‚ç‹€æ…‹èˆ‡ BLU ç´¯ç©</h2>
      <p>ç›®å‰ç™»å…¥ä½¿ç”¨è€… idï¼š<span id="userId"></span></p>

      <p>ç¸½ç´¯ç© BLU åšåº¦ï¼š<span id="totalBlu">è¼‰å…¥ä¸­...</span></p>
      <p>ç”Ÿå‘½éˆæ•¸ï¼š<span id="lifeNumber">è¼‰å…¥ä¸­...</span></p>
      <p>éˆé­‚å…¥å£æ¨™ç±¤ï¼š<span id="entryLabel">è¼‰å…¥ä¸­...</span></p>

      <hr />

      <h2>3. å»ºç«‹ / åˆå§‹åŒ– Profileï¼ˆéˆé­‚èª•ç”Ÿï¼‰</h2>
      <p>
        <label for="birthDate">ä½ çš„ç”Ÿæ—¥ï¼š</label>
        <input id="birthDate" type="date" />
      </p>
      <p>
        <button id="initProfileBtn">åˆå§‹åŒ–éˆé­‚æª”æ¡ˆï¼ˆè¨ˆç®—ç”Ÿå‘½éˆæ•¸ä¸¦ç”Ÿæˆæ¨™ç±¤ï¼‰</button>
      </p>
      <p id="profileStatus">ï¼ˆéœ€è¼¸å…¥ç”Ÿæ—¥ä¸¦åˆå§‹åŒ–æ‰èƒ½ç”Ÿæˆéˆé­‚æ¨™ç±¤ï¼‰</p>

      <hr />

      <h2>4. æ¸¬è©¦ BLU å¯«å…¥</h2>
      <button id="addBluBtn">+0.5 BLU ï¼ˆä¸€æ¬¡è¦ªæ„›çš„ï¼‰</button>
      <p id="bluStatus"></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // **è«‹ç¢ºèªé€™å…©è¡Œæ˜¯å¦³çš„ Supabase å°ˆæ¡ˆå¯†é‘°**
      const SUPABASE_URL = "https://amqgpwrhxzrhvaknsasl.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFtcWdwd3JoeHpyaHZha25zYXNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NzExMDYsImV4cCI6MjA4MDM0NzEwNn0.cOVpCvBS42_GIBR2zA4J0TqatYMZgeQ-mwLwYjmPTKU";

      const { createClient } = supabase;
      const client = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // DOM å…ƒç´ å®šç¾©
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const authStatus = document.getElementById("authStatus");
      const appArea = document.getElementById("appArea");
      const userIdSpan = document.getElementById("userId");
      const bluStatus = document.getElementById("bluStatus");
      const totalBluSpan = document.getElementById("totalBlu");
      const lifeNumberSpan = document.getElementById("lifeNumber");
      const entryLabelSpan = document.getElementById("entryLabel");
      const birthDateInput = document.getElementById("birthDate");
      const initProfileBtn = document.getElementById("initProfileBtn");
      const profileStatus = document.getElementById("profileStatus");

      // ====== å·¥å…·å‡½å¼ï¼šè¨ˆç®—ç”Ÿå‘½éˆæ•¸ï¼ˆ1~9ï¼‰ ======
      function calculateLifePath(dateStr) {
        if (!dateStr) return null;

        // åªä¿ç•™æ•¸å­—ï¼Œä¾‹å¦‚ "1990-07-15" -> "19900715"
        const digits = dateStr.replace(/\D/g, "");
        if (!digits) return null;

        let sum = 0;
        for (let i = 0; i < digits.length; i++) {
          sum += Number(digits[i]);
        }

        // æŒçºŒæŠŠä½æ•¸ç›¸åŠ ï¼Œç›´åˆ°å‰©ä¸€ä½æ•¸ï¼ˆ1~9ï¼‰
        while (sum > 9) {
          sum = sum
            .toString()
            .split("")
            .reduce((acc, d) => acc + Number(d), 0);
        }

        return sum; // ç›®å‰å…ˆä¸è™•ç† 11/22 ç­‰å¤§å¸«æ•¸ï¼Œä¿æŒç°¡å–®
      }

      // ====== å·¥å…·å‡½å¼ï¼šç”Ÿæˆå…¥å£æ¨™ç±¤ ======
      function generateEntryLabel(lifeNumber, bluTotal) {
        if (!lifeNumber) return "æœªçŸ¥ãƒ»æ¢ç´¢è€…ï½œBLU 0.0";
        return `${lifeNumber}è™Ÿäººï½œBLU ${bluTotal.toFixed(1)}`;
      }


      // è®€å– BLU ç¸½é‡å’Œ Profile
      async function fetchTotalBluAndProfile(userId) {
        // 1. è®€å– BLU Logs
        const { data: bluData, error: bluError } = await client
          .from("blu_logs")
          .select("blu_value")
          .eq("user_id", userId);

        let totalBlu = 0;
        if (bluError) {
          totalBluSpan.textContent = "è¼‰å…¥ BLU éŒ¯èª¤ï¼";
          console.error("BLU Fetch Error:", bluError);
        } else {
          totalBlu = bluData.reduce((sum, log) => sum + (parseFloat(log.blu_value) || 0), 0);
          totalBluSpan.textContent = totalBlu.toFixed(1);
        }

        // 2. è®€å– Profileï¼ˆåŒ…å« entry_label, life_number, birth_dateï¼‰
        const { data: profileData, error: profileError } = await client
          .from("profiles")
          .select("entry_label, life_number, birth_date")
          .eq("id", userId)
          .single();

        if (profileError && profileError.code !== 'PGRST116') { // PGRST116 æ‰¾ä¸åˆ°è³‡æ–™
            entryLabelSpan.textContent = "è¼‰å…¥æ¨™ç±¤éŒ¯èª¤ï¼";
            lifeNumberSpan.textContent = "è¼‰å…¥éŒ¯èª¤";
            console.error("Profile Fetch Error:", profileError);
            profileStatus.textContent = "âŒ éŒ¯èª¤ï¼šProfile è®€å–å¤±æ•—ã€‚";
        } else if (profileData) {
          // é¡¯ç¤º entry_label
          entryLabelSpan.textContent = profileData.entry_label || "æœªè¨­å®š";

          // é¡¯ç¤º life_number
          if (profileData.life_number) {
            lifeNumberSpan.textContent = profileData.life_number + " è™Ÿ";
          } else {
            lifeNumberSpan.textContent = "å°šæœªè¨ˆç®—ï¼ˆè«‹è¼¸å…¥ç”Ÿæ—¥ä¸¦åˆå§‹åŒ–ï¼‰";
          }

          // å¦‚æœæœ‰ birth_dateï¼Œè‡ªå‹•å¡«å…¥æ—¥æœŸæ¬„ä½
          if (profileData.birth_date) {
            birthDateInput.value = profileData.birth_date;
          }

          // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›´æ–° life_number
          if (!profileData.life_number && profileData.birth_date) {
            profileStatus.textContent = "âš  å·²æœ‰ç”Ÿæ—¥è³‡æ–™ï¼Œä½†å°šæœªè¨ˆç®—ç”Ÿå‘½éˆæ•¸ï¼Œè«‹é»æ“Šåˆå§‹åŒ–æŒ‰éˆ•æ›´æ–°ã€‚";
          } else if (!profileData.life_number) {
            profileStatus.textContent = "âš  å°šæœªè¨­å®šç”Ÿæ—¥ï¼Œè«‹è¼¸å…¥ç”Ÿæ—¥å¾Œé»æ“Šåˆå§‹åŒ–æŒ‰éˆ•ã€‚";
          } else {
            profileStatus.textContent = "âœ… éˆé­‚æª”æ¡ˆå®Œæ•´ï¼ˆç”Ÿå‘½éˆæ•¸ï¼š" + profileData.life_number + "è™Ÿï¼‰";
          }
        } else {
            entryLabelSpan.textContent = "æœªæ‰¾åˆ°æ¨™ç±¤ï¼Œè«‹å…ˆåˆå§‹åŒ–";
            lifeNumberSpan.textContent = "å°šæœªåˆå§‹åŒ–";
            profileStatus.textContent = "âš  Profile ä¸å­˜åœ¨ï¼Œè«‹è¼¸å…¥ç”Ÿæ—¥ä¸¦é»æ“Šåˆå§‹åŒ–æŒ‰éˆ•ã€‚";
        }
      }


      // æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹
      async function refreshUser() {
        const {
          data: { user },
        } = await client.auth.getUser();

        if (user) {
          appArea.style.display = "block";
          userIdSpan.textContent = user.id;
          authStatus.textContent = "å·²ç™»å…¥";
          await fetchTotalBluAndProfile(user.id);
        } else {
          appArea.style.display = "none";
          authStatus.textContent = "å°šæœªç™»å…¥";
          totalBluSpan.textContent = '0';
          entryLabelSpan.textContent = 'è¼‰å…¥ä¸­...';
          profileStatus.textContent = 'è«‹å…ˆç™»å…¥';
        }
      }

      // **[æ ¸å¿ƒåŠŸèƒ½å‡ç´š]** å»ºç«‹ / æ›´æ–° Profileï¼ˆå«ç”Ÿå‘½éˆæ•¸è¨ˆç®—èˆ‡æ¨™ç±¤ç”Ÿæˆï¼‰
      initProfileBtn.onclick = async () => {
        profileStatus.textContent = "ğŸŒŸ éˆé­‚æª”æ¡ˆè™•ç†ä¸­...";

        const {
          data: { user },
        } = await client.auth.getUser();

        if (!user) {
          profileStatus.textContent = "âŒ å°šæœªç™»å…¥ã€‚";
          return;
        }

        // è®€å–ç”Ÿæ—¥
        const birthDate = birthDateInput.value;
        if (!birthDate) {
          profileStatus.textContent = "âš  è«‹å…ˆè¼¸å…¥ä½ çš„ç”Ÿæ—¥ã€‚";
          return;
        }

        // è¨ˆç®—ç”Ÿå‘½éˆæ•¸
        const lifeNumber = calculateLifePath(birthDate);
        if (!lifeNumber) {
          profileStatus.textContent = "âŒ ç”Ÿæ—¥æ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è¨ˆç®—ç”Ÿå‘½éˆæ•¸ã€‚";
          return;
        }

        // è®€å– BLU ç¸½é‡
        const { data: bluData } = await client
          .from("blu_logs")
          .select("blu_value")
          .eq("user_id", user.id);

        const totalBlu = bluData
          ? bluData.reduce((sum, log) => sum + (parseFloat(log.blu_value) || 0), 0)
          : 0;

        // ç”Ÿæˆå…¥å£æ¨™ç±¤
        const entryLabel = generateEntryLabel(lifeNumber, totalBlu);

        // ä½¿ç”¨ upsertï¼šå¦‚æœæ²’æœ‰ profile å°±æ–°å¢ï¼Œæœ‰çš„è©±å°±æ›´æ–°
        const { error } = await client.from("profiles").upsert({
          id: user.id,
          birth_date: birthDate,
          life_number: lifeNumber,
          entry_label: entryLabel
        });

        if (error) {
          profileStatus.textContent = "âŒ åˆå§‹åŒ–å¤±æ•—ï¼š" + error.message;
          console.error("Profile Init Error:", error);
        } else {
          profileStatus.textContent = `âœ… éˆé­‚è¦ºé†’å®Œæˆï¼ä½ æ˜¯ ${lifeNumber} è™Ÿäººï¼Œæ¨™ç±¤ï¼š${entryLabel}`;
          // é‡æ–°è®€å– profile ç‹€æ…‹
          await fetchTotalBluAndProfile(user.id);
        }
      };


      // è¨»å†ŠåŠŸèƒ½ (ä¸è®Š)
      document.getElementById("signupBtn").onclick = async () => {
        const email = emailInput.value;
        const password = passwordInput.value;

        authStatus.textContent = "è¨»å†Šä¸­...";
        const { data, error } = await client.auth.signUp({
          email,
          password,
        });

        if (error) {
          authStatus.textContent = "è¨»å†Šå¤±æ•—ï¼š" + error.message;
        } else {
          authStatus.textContent = "è¨»å†ŠæˆåŠŸï¼Œè«‹å†æŒ‰ä¸€æ¬¡ã€ç™»å…¥ã€";
        }
      };

      // ç™»å…¥åŠŸèƒ½
      document.getElementById("loginBtn").onclick = async () => {
        const email = emailInput.value;
        const password = passwordInput.value;

        authStatus.textContent = "ç™»å…¥ä¸­...";
        const { data, error } = await client.auth.signInWithPassword({
          email,
          password,
        });

        if (error) {
          authStatus.textContent = "ç™»å…¥å¤±æ•—ï¼š" + error.message;
        } else {
          authStatus.textContent = "ç™»å…¥æˆåŠŸï¼";
          await refreshUser();
        }
      };

      // å¯«å…¥ BLU åŠŸèƒ½ï¼ˆä¸¦è‡ªå‹•æ›´æ–° entry_labelï¼‰
      document.getElementById("addBluBtn").onclick = async () => {
        bluStatus.textContent = "å¯«å…¥ä¸­...";

        const {
          data: { user },
        } = await client.auth.getUser();

        if (!user) {
          bluStatus.textContent = "å°šæœªç™»å…¥ï¼Œè«‹å…ˆç™»å…¥ã€‚";
          return;
        }

        const { error } = await client.from("blu_logs").insert({
          user_id: user.id,
          blu_value: 0.5,
          description: "æ‰‹å‹•æ¸¬è©¦ +0.5 BLU",
        });

        if (error) {
          bluStatus.textContent = "å¯«å…¥å¤±æ•—ï¼š" + error.message;
        } else {
          bluStatus.textContent = "âœ… æˆåŠŸå¯«å…¥ä¸€ç­† +0.5 BLUï¼";

          // æˆåŠŸå¾Œé‡æ–°è®€å–ä¸¦æ›´æ–° entry_label
          const { data: profileData } = await client
            .from("profiles")
            .select("life_number")
            .eq("id", user.id)
            .single();

          if (profileData && profileData.life_number) {
            // é‡æ–°è¨ˆç®— BLU ç¸½é‡
            const { data: bluData } = await client
              .from("blu_logs")
              .select("blu_value")
              .eq("user_id", user.id);

            const totalBlu = bluData
              ? bluData.reduce((sum, log) => sum + (parseFloat(log.blu_value) || 0), 0)
              : 0;

            // é‡æ–°ç”Ÿæˆ entry_label
            const newEntryLabel = generateEntryLabel(profileData.life_number, totalBlu);

            // æ›´æ–° entry_label
            await client.from("profiles").update({
              entry_label: newEntryLabel
            }).eq("id", user.id);

            bluStatus.textContent = `âœ… æˆåŠŸå¯«å…¥ +0.5 BLUï¼æ¨™ç±¤å·²æ›´æ–°ç‚ºï¼š${newEntryLabel}`;
          }

          await fetchTotalBluAndProfile(user.id); // é‡æ–°æ•´ç†ç•«é¢
        }
      };

      // ä¸€é€²ä¾†å…ˆæª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
      refreshUser();
    </script>
  </body>
</html>